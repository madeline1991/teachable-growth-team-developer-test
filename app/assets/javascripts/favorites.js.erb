$(document).ready(function () {
  const $favorites = $('#favorites-list')
  let storage = getLocalStorage();

  if ($favorites.length > 0) {
    loadFavorites($favorites, storage);
    favoritesPageSelected();
  } else {
    searchPageSelected();
  }

  swapStars(storage);
  setStarToggle();
});

const loadFavorites = ($listContainer, storage) => {
  if (storage.length === 0) {
    $listContainer.append("<li>None</li>")
  } else {
    for(let i = 0; i < storage.length; i++) {
      const gem = storage[i];
      const button = returnButton(gem);
      const link = "<a href=\"https://rubygems.org/gems/" + gem +"\">" + gem + "</a>"
      const element = "<li>" + button + link + "</li>"
    $listContainer.append(element);
    }
  }
}

const swapStars = (storage) => {
  let starButtons = $(".toggle")
  for(let i = 0; i < starButtons.length; i++) {
    const $button = $(starButtons[i]);
    let gem = $button.attr('id');
    if (storage.includes(gem)) {
      $($button.children()).attr("src", '<%= asset_path("star-blue.png") %>');
    };
  };
}

const setStarToggle = () => {
  $(".toggle").click(function(e) {
    let storage = getLocalStorage();
    const $image = $(e.target);
    const gem = $image.parent().attr('id');
    if (storage.includes(gem)) {
      let index = storage.indexOf(gem)
      let newStorage = storage.slice(0, index).concat(storage.slice(index + 1))
      setLocalStorage(newStorage);
      $image.attr("src", '<%= asset_path("star-gray.png") %>')
    } else {
      storage.push(gem)
      setLocalStorage(storage);
      $image.attr("src", '<%= asset_path("star-blue.png") %>')
    }
  });
}

const getLocalStorage = () => {
  return JSON.parse(localStorage.getItem("favorites")) || [];
}

const setLocalStorage = (array) => {
  localStorage.setItem("favorites", JSON.stringify(array));
}

const returnButton = (gem) => {
    return '<button id=\"' + gem + '\" class="toggle">' + '<%= image_tag("star-gray.png") %>' + '</button>'
}

const favoritesPageSelected = () => {
  $("#favorites-link").addClass("current-page");
  $("#search-link").removeClass("current-page");
}

const searchPageSelected = () => {
  $("#favorites-link").removeClass("current-page");
  $("#search-link").addClass("current-page");
}
